---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import DocsLayout from '../../layouts/DocsLayout.astro';

const CATEGORY_ORDER = ['intro', 'idea', 'code', 'figures', 'writing', 'review', 'tools', 'library'] as const;
const CATEGORY_TITLES: Record<string, string> = {
  intro: '0. 导读',
  idea: '1. Idea 生成',
  code: '2. 代码实现',
  figures: '3. 论文图表',
  writing: '4. 论文写作',
  review: '5. 审稿与 Rebuttal',
  tools: '6. 工具生态',
  library: '7. 资料库',
};

export async function getStaticPaths() {
  const docs = await getCollection('docs');
  return docs.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}
const { entry } = Astro.props as { entry: CollectionEntry<'docs'> };
const docs = await getCollection('docs');

const sortedDocs = docs.sort((a, b) => {
  const ca = CATEGORY_ORDER.indexOf(a.data.category as (typeof CATEGORY_ORDER)[number]);
  const cb = CATEGORY_ORDER.indexOf(b.data.category as (typeof CATEGORY_ORDER)[number]);
  if (ca !== cb) return ca - cb;
  if (a.data.order !== b.data.order) return a.data.order - b.data.order;
  return a.slug.localeCompare(b.slug);
});

const grouped = CATEGORY_ORDER
  .map((key) => ({
    key,
    title: CATEGORY_TITLES[key],
    items: sortedDocs
      .filter((doc) => doc.data.category === key)
      .map((doc) => ({
        slug: doc.slug,
        title: doc.data.title,
        order: doc.data.order,
      })),
  }))
  .filter((group) => group.items.length > 0);

const currentIndex = sortedDocs.findIndex((doc) => doc.slug === entry.slug);
const prev = currentIndex > 0
  ? {
      slug: sortedDocs[currentIndex - 1].slug,
      title: sortedDocs[currentIndex - 1].data.title,
      order: sortedDocs[currentIndex - 1].data.order,
    }
  : null;
const next = currentIndex >= 0 && currentIndex < sortedDocs.length - 1
  ? {
      slug: sortedDocs[currentIndex + 1].slug,
      title: sortedDocs[currentIndex + 1].data.title,
      order: sortedDocs[currentIndex + 1].data.order,
    }
  : null;

const { Content, headings } = await entry.render();
---

<DocsLayout
  title={entry.data.title}
  description={entry.data.description}
  currentSlug={entry.slug}
  groups={grouped}
  headings={headings}
  prev={prev}
  next={next}
>
  <Content />
</DocsLayout>
